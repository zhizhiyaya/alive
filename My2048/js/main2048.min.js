$(document).ready(function(){var e=$("#cell-grid");var t=new Newgame(e);t.init()});function Newgame(e){this.dom=e;this.cell=null;this.board=[];this.score=this.dom.find("#score");this.scoreNum=0;this.scale=this.dom.find(".m-cell").eq(0).width();this.space=this.dom.width()*.04;this.fontStyle=(this.scale+this.space)*4>320?"font-size1":"font-size2";this.hasConflicted=[];this.delayTime=[50,120,150,160,200]}Newgame.prototype.init=function(){this.dom.height(this.dom.width());for(var e=0;e<4;e++){this.board[e]=[];this.hasConflicted[e]=[];for(var t=0;t<4;t++){this.board[e][t]=0;this.hasConflicted[e][t]=false}}this.updateBoardView();this.addNumCell();this.addNumCell();this.keyDown();this.touch()};Newgame.prototype._setGrid=function(){};Newgame.prototype.updateBoardView=function(){$(".m-num-cell").remove();for(var e=0;e<4;e++){for(var t=0;t<4;t++){this.dom.append('<div class="m-num-cell" id="num-cell-'+e+"-"+t+'"></div>');var i=$("#num-cell-"+e+"-"+t);if(this.board[e][t]==0){i.addClass("board0");i.css({top:this.setTop(e,t),left:this.setLeft(e,t)})}else{i.addClass("m-board").addClass(this.fontStyle);i.css({top:this.setTop(e,t),left:this.setLeft(e,t),background:this.setBgColor(this.board[e][t]),color:this.setNumColor(this.board[e][t])});i.text(this.board[e][t])}this.hasConflicted[e][t]=false}}};Newgame.prototype.updateScore=function(){$("#score").text(this.scoreNum)};Newgame.prototype.addNumCell=function(){if(!this.noSpace)return false;var e=parseInt(Math.floor(Math.random()*4));var t=parseInt(Math.floor(Math.random()*4));if(this.board[e][t]==0){var i=Math.random()<.5?2:4;this.board[e][t]=i;this.showNumWithAnimation(e,t,i);return true}else{this.addNumCell()}};Newgame.prototype.noSpace=function(){for(var e=0;e<4;e++){for(var t=0;t<4;t++){if(this.board[e][t]==0){return true}}}return false};Newgame.prototype.showNumWithAnimation=function(e,t,i){var o=this;var a=$("#num-cell-"+e+"-"+t);a.css({background:this.setBgColor(i),color:this.setNumColor(i)}).removeClass("board0");a.addClass(this.fontStyle);a.text(i);a.animate({width:"21%",height:"21%",maxWidth:"100px",maxHeight:"100px",top:this.setTop(e,t),left:this.setLeft(e,t)},o.delayTime[0]);var r=document.getElementById("num-cell-"+e+"-"+t);$(r).text(i)};Newgame.prototype.setTop=function(e,t){return this.space+(this.space+this.scale)*e};Newgame.prototype.setLeft=function(e,t){return this.space+(this.space+this.scale)*t};Newgame.prototype.setBgColor=function(e){switch(e){case 2:return"#eee4da";break;case 4:return"#ede0c8";break;case 8:return"#f2b179";break;case 16:return"#f59563";break;case 32:return"#f67c5f";break;case 64:return"#f65e3b";break;case 128:return"#edcf72";break;case 256:return"#edcc61";break;case 512:return"#9c0";break;case 1024:return"#33b5e5";break;case 2048:return"#09c";break;case 4096:return"#a6c";break;case 8192:return"#93c";break}};Newgame.prototype.setNumColor=function(e){if(e<=4){return"#776e6e"}return"white"};Newgame.prototype.keyDown=function(){var e=this;$(document).keydown(function(t){switch(t.keyCode){case 37:t.preventDefault();if(e.moveLeft()){setTimeout(function(){e.addNumCell()},e.delayTime[3])}break;case 38:t.preventDefault();if(e.moveUp()){setTimeout(function(){e.addNumCell()},e.delayTime[3])}break;case 39:t.preventDefault();if(e.moveRight()){setTimeout(function(){e.addNumCell()},e.delayTime[3])}break;case 40:t.preventDefault();if(e.moveDown()){setTimeout(function(){e.addNumCell()},e.delayTime[3])}break;default:break}setTimeout(function(){e.isGameOver()},e.delayTime[4])})};Newgame.prototype.isGameOver=function(){if(!this.noSpace()&&!this.canMoveLeft()&&!this.canMoveRight()&&!this.canMoveUp()&&!this.canMoveDown()){this.gameOver()}return false};Newgame.prototype.gameOver=function(){if(this.fontStyle=="font-size1"){$(".over").addClass("over1");return false}if(this.fontStyle=="font-size2"){$(".over").addClass("over2");return false}};Newgame.prototype.moveLeft=function(){var e=this;if(!e.canMoveLeft())return false;for(i=0;i<4;i++){for(var t=1;t<4;t++){if(e.board[i][t]!=0){for(var o=0;o<t;o++){if(e.board[i][o]==0&&e.noBlockHorizontal(i,o,t)){e.showMoveAnimation(i,t,i,o);e.board[i][o]=e.board[i][t];e.board[i][t]=0;continue}else if(e.board[i][o]==e.board[i][t]&&e.noBlockHorizontal(i,o,t)&&!e.hasConflicted[i][o]){e.showMoveAnimation(i,t,i,o);e.board[i][o]+=e.board[i][t];e.board[i][t]=0;e.scoreNum+=e.board[i][o];e.updateScore();e.hasConflicted[i][o]=true;continue}}}}}setTimeout(function(){e.updateBoardView()},e.delayTime[2]);return true};Newgame.prototype.moveRight=function(){var e=this;if(!e.canMoveRight())return false;for(i=0;i<4;i++){for(var t=2;t>=0;t--){if(e.board[i][t]!=0){for(var o=3;o>t;o--){if(e.board[i][o]==0&&e.noBlockHorizontal(i,t,o)){e.showMoveAnimation(i,t,i,o);e.board[i][o]=e.board[i][t];e.board[i][t]=0;continue}else if(e.board[i][o]==e.board[i][t]&&e.noBlockHorizontal(i,t,o)&&!e.hasConflicted[i][o]){e.showMoveAnimation(i,t,i,o);e.board[i][o]+=e.board[i][t];e.board[i][t]=0;e.scoreNum+=e.board[i][o];e.updateScore();e.hasConflicted[i][o]=true;continue}}}}}setTimeout(function(){e.updateBoardView()},e.delayTime[2]);return true};Newgame.prototype.moveUp=function(){var e=this;if(!e.canMoveUp())return false;for(i=0;i<4;i++){for(var t=1;t<4;t++){if(e.board[t][i]!=0){for(var o=0;o<t;o++){if(e.board[o][i]==0&&e.noBlockVertical(i,o,t)){e.showMoveAnimation(t,i,o,i);e.board[o][i]=e.board[t][i];e.board[t][i]=0;continue}else if(e.board[t][i]==e.board[o][i]&&e.noBlockVertical(i,o,t)&&!e.hasConflicted[o][i]){e.showMoveAnimation(t,i,o,i);e.board[o][i]+=e.board[t][i];e.board[t][i]=0;e.scoreNum+=e.board[o][i];e.updateScore();e.hasConflicted[o][i]=true;continue}}}}}setTimeout(function(){e.updateBoardView()},e.delayTime[2]);return true};Newgame.prototype.moveDown=function(){var e=this;if(!e.canMoveDown())return false;for(i=0;i<4;i++){for(var t=2;t>=0;t--){if(e.board[t][i]!=0){for(var o=3;o>t;o--){if(e.board[o][i]==0&&e.noBlockVertical(i,t,o)){e.showMoveAnimation(t,i,o,i);e.board[o][i]+=e.board[t][i];e.board[t][i]=0;continue}else if(e.board[t][i]==e.board[o][i]&&e.noBlockVertical(i,t,o)&&!e.hasConflicted[o][i]){e.showMoveAnimation(t,i,o,i);e.board[o][i]+=e.board[t][i];e.board[t][i]=0;e.scoreNum+=e.board[o][i];e.updateScore();e.hasConflicted[o][t]=true;continue}}}}}setTimeout(function(){e.updateBoardView()},e.delayTime[2]);return true};Newgame.prototype.canMoveLeft=function(){for(i=0;i<4;i++){for(var e=1;e<4;e++){if(this.board[i][e]!=0){if(this.board[i][e-1]==0||this.board[i][e-1]==this.board[i][e]){return true}}}}return false};Newgame.prototype.canMoveRight=function(){for(i=0;i<4;i++){for(var e=2;e>=0;e--){if(this.board[i][e]!=0){if(this.board[i][e+1]==0||this.board[i][e]==this.board[i][e+1]){return true}}}}return false};Newgame.prototype.canMoveUp=function(){for(i=0;i<4;i++){for(var e=1;e<4;e++){if(this.board[e][i]!=0){if(this.board[e-1][i]==0||this.board[e-1][i]==this.board[e][i]){return true}}}}return false};Newgame.prototype.canMoveDown=function(){for(i=0;i<4;i++){for(var e=0;e<3;e++){if(this.board[e][i]!=0){if(this.board[e+1][i]==0||this.board[e][i]==this.board[e+1][i]){return true}}}}return false};Newgame.prototype.noBlockHorizontal=function(e,t,i){for(var o=t+1;o<i;o++){if(this.board[e][o]!=0)return false}return true};Newgame.prototype.noBlockVertical=function(e,t,i){for(var o=t+1;o<i;o++){if(this.board[o][e]!=0)return false}return true};Newgame.prototype.showMoveAnimation=function(e,t,i,o){var a=$("#num-cell-"+e+"-"+t);var r=this;a.animate({top:this.setTop(i,o),left:this.setLeft(i,o)},r.delayTime[1])};Newgame.prototype.touch=function(){var e=startY=0;var t=endY=0;var i=this;document.addEventListener("touchstart",function(t){i.delayTime=[0,30,40,50,60];e=t.changedTouches[0]["pageX"];startY=t.changedTouches[0]["pageY"]});document.addEventListener("touchmove",function(e){e.preventDefault()});document.addEventListener("touchend",function(o){t=o.changedTouches[0]["pageX"];endY=o.changedTouches[0]["pageY"];i.judgeMove(e,startY,t,endY)})};Newgame.prototype.judgeMove=function(e,t,i,o){var a=this;var r=window.screen.availWidth;var n=e-i;var s=t-o;if(Math.abs(n)<.1*r&&Math.abs(s)<.1*r)return;if(Math.abs(n)>Math.abs(s)){if(n>0){if(this.moveLeft()){setTimeout(function(){a.addNumCell()},a.delayTime[3])}}else{if(this.moveRight()){setTimeout(function(){a.addNumCell()},a.delayTime[3])}}}else{if(s>0){if(this.moveUp()){setTimeout(function(){a.addNumCell()},a.delayTime[3])}}else{if(this.moveDown()){setTimeout(function(){a.addNumCell()},a.delayTime[3])}}}setTimeout(function(){a.isGameOver()},a.delayTime[4])};